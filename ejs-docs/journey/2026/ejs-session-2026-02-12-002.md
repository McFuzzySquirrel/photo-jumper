session_id: ejs-session-2026-02-12-002
author: copilot
date: 2026-02-12
repo: McFuzzySquirrel/photo-jumper
branch: copilot/refactor-android-ui
agents_involved: [copilot-coding-agent]
decision_detected: false
adr_links: [docs/adr/0010-android-game-app-packaging-with-capacitor.md]
tags: [android, capacitor, implementation, mobile-ux, touch-controls, haptics]
refs: [docs/prd/android-game-app-plan.md]

# Problem / Intent

Implement Phase 0 (Capacitor setup) and Phase 1 (UI refactoring) of the Android game app plan approved in ADR 0010. This session converts the planning documents into working code.

# Interaction Summary (Required)

- Human: Approved the plan with "This is great, we don't see anything wrong. Can we get this going?"
  - Agent: Began implementation of Phase 0 and Phase 1
  - Outcome: Full Capacitor project setup + UI refactoring completed

- Agent: Phase 0 — Capacitor Project Setup
  - Installed @capacitor/core, @capacitor/cli, @capacitor/android + 6 plugins
  - Created capacitor.config.ts with Android WebView settings, splash screen, status bar config
  - Generated Android project with landscape orientation lock and camera permission
  - Updated .gitignore (www/, android build artifacts, keystores)
  - Added npm scripts: cap:copy, cap:sync, cap:open
  - Outcome: Working Android project structure

- Agent: Phase 1 — UI Refactoring
  - Created js/platform/native-bridge.js (Capacitor plugin wrappers with web fallbacks)
  - Created css/android-game.css (native-app CSS overrides: fullscreen layout, 64-80dp controls, safe areas, pause/victory overlays)
  - Updated index.html (pause button, pause overlay, victory overlay, ML loading overlay, thumb-zone mobile controls)
  - Updated js/main.js (native detection, pause/resume states, victory screen, haptic feedback, back button, auto-ML, auto-model-load)
  - Updated sw.js (cache new files)
  - Outcome: All Phase 1 features implemented, web compatibility verified

- Human: Clarified "app" means "game app"
  - Agent: Already captured in planning session; implementation follows game-specific UX patterns
  - Outcome: Touch controls sized at 64-80dp for game use, not generic 48dp

# Agent Collaboration Summary

**Key implementation decisions:**
- Used dynamic ESM imports for Capacitor plugins in native-bridge.js to avoid build tooling
- webDir set to 'www' (rsync copy) since Capacitor doesn't support '.' as webDir
- Pause state implemented as game loop skip (requestAnimationFrame continues but no updates)
- Victory overlay shown once via classList check to prevent re-rendering every frame

**Key files created/modified:**
- 2 new files: js/platform/native-bridge.js, css/android-game.css
- 3 modified files: index.html, js/main.js, sw.js
- Capacitor project: capacitor.config.ts, android/ directory, package.json

# Agent Influence (Required)

- **Suggestions adopted:**
  - www/ directory approach for Capacitor webDir (Capacitor requires a subdirectory)
  - Dynamic imports for plugin loading (avoids bundler requirement)
  - Pause state as game loop modifier (simplest approach)

- **Suggestions rejected:** None

- **Human overrides:** None in this session

# Experiments / Evidence

- **Web compatibility verified**: Loaded game in browser, confirmed splash → intro → game flow works unchanged
- **No JS errors**: Console shows only pre-existing icon size warning
- **Module loading**: native-bridge.js imports successfully (isNative() returns false on web, all native calls gracefully degrade)

# Key Learnings

- Capacitor webDir cannot be '.' — must use a subdirectory and copy files
- TypeScript must be installed for Capacitor to read .ts config files
- @capacitor/android must be installed separately from @capacitor/core
- Dynamic ESM imports from CDN (esm.sh) work for lazy-loading Capacitor plugins without a bundler

# If Repeating This Work

**Do this:**
- Install @capacitor/android before running `npx cap add android`
- Install TypeScript before creating capacitor.config.ts
- Test web compatibility immediately after making main.js changes

**Avoid:**
- Setting webDir to '.' in Capacitor config
- Importing Capacitor plugins statically (would break web builds without bundler)

**Watch out for:**
- Capacitor plugin versions must match @capacitor/core major version

## MACHINE EXTRACTS

### INTERACTION_EXTRACT
- session: ejs-session-2026-02-12-002
- intent: Implement Phase 0 + Phase 1 of Android game app plan
- key_interactions:
  - phase_0_completed: Capacitor project setup with Android platform
  - phase_1_completed: UI refactoring with native bridge, CSS overrides, touch controls, pause/victory, haptics
  - web_compatibility: verified (no breaking changes)

### DECISIONS_EXTRACT
- decisions:
  - webDir: www/ with rsync copy (Capacitor limitation)
  - plugin_loading: dynamic ESM imports from esm.sh CDN
  - pause_state: game loop modifier (gamePaused flag)

### LEARNING_EXTRACT
- learnings:
  - capacitor_webDir: cannot be '.' — requires subdirectory
  - capacitor_android: separate package from core
  - typescript_required: for .ts config files
  - dynamic_imports: work for Capacitor plugins via esm.sh

### AGENT_GUIDANCE_EXTRACT
- guidance:
  - always_install_android_package: before npx cap add android
  - test_web_compat: immediately after main.js changes
  - use_dynamic_imports: for Capacitor plugins to avoid bundler dependency
